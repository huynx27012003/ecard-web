<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <% const getVal=(name, fallback='' )=> {
        if (typeof selectedItem !== 'undefined' && selectedItem && selectedItem.templateFields) {
        const field = selectedItem.templateFields.find(f => f.fieldName === name);
        if (field && field.fieldValue) return field.fieldValue;
        }
        return fallback;
        };
        const stName = getVal('Name', user.username);
        const stRole = getVal('Role');
        const stEmail = getVal('ContactEmail', user.email);
        const stPhone1 = getVal('Phone1', user.number);
        const stPhone2 = getVal('Phone2');
        const stAddress = getVal('Address');
        const stCompany = getVal('Company');
        const stURL = getVal('URL');
        const stVideo = getVal('VideoURL');
        const stColor = (typeof selectedItem !== 'undefined' && selectedItem && selectedItem.bgColor) ?
        selectedItem.bgColor : '#012596';
        const stImage = (typeof selectedItem !== 'undefined' && selectedItem && selectedItem.Image) ? selectedItem.Image
        : '';
        %>
        <title>Thiết Kế Danh Thiếp - AT Digital Card</title>
        <link rel="shortcut icon" href="/public/assets/icon.ico">
        <link rel="stylesheet" href="/public/assets/admin/plugins/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="/public/assets/admin/plugins/fontawesome/css/fontawesome.min.css">
        <link rel="stylesheet" href="/public/assets/admin/plugins/fontawesome/css/all.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="/public/assets/admin/css/style.css">

        <style>
            :root {
                --primary-blue: #012596;
                --primary-blue-dark: #011d78;
                --primary-blue-light: #1a3db8;
                --accent-red: #CC0514;
                --text-dark: #1a1a2e;
                --text-muted: #6b7280;
                --bg-light: #f8faff;
                --border-color: #e5e7eb;
                --success: #10b981;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                background: var(--bg-light);
                min-height: 100vh;
            }

            /* Main Content Area */
            .page-wrapper {
                margin-left: 240px;
                padding-top: 60px;
                min-height: 100vh;
                transition: all 0.3s ease;
            }

            .mini-sidebar .page-wrapper {
                margin-left: 70px;
            }

            @media (max-width: 991px) {
                .page-wrapper {
                    margin-left: 0;
                }
            }

            /* Studio Layout */
            .studio-container {
                display: flex;
                height: calc(100vh - 60px);
                overflow: hidden;
            }

            /* Editor Panel */
            .editor-panel {
                width: 380px;
                background: white;
                border-right: 1px solid var(--border-color);
                display: flex;
                flex-direction: column;
                overflow: hidden;
                flex-shrink: 0;
            }

            .editor-header {
                padding: 16px 20px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .editor-header h2 {
                font-size: 16px;
                font-weight: 600;
                color: var(--text-dark);
                margin: 0;
            }

            .template-badge {
                padding: 6px 12px;
                background: var(--bg-light);
                border: 1px solid var(--border-color);
                border-radius: 6px;
                font-size: 12px;
                color: var(--text-muted);
            }

            .editor-scroll {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
            }

            .section-title {
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 14px;
                font-weight: 600;
                color: var(--text-dark);
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 1px solid var(--border-color);
            }

            .section-title i {
                color: var(--primary-blue);
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-label {
                display: block;
                font-size: 12px;
                font-weight: 600;
                color: var(--text-muted);
                margin-bottom: 6px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .form-control {
                width: 100%;
                padding: 12px 14px;
                font-size: 14px;
                border: 1.5px solid var(--border-color);
                border-radius: 10px;
                transition: all 0.2s ease;
                background: var(--bg-light);
            }

            .form-control:focus {
                outline: none;
                border-color: var(--primary-blue);
                background: white;
                box-shadow: 0 0 0 4px rgba(1, 37, 150, 0.1);
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            /* Color Picker */
            .color-picker-wrapper {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .color-picker-wrapper input[type="color"] {
                width: 48px;
                height: 48px;
                padding: 0;
                border: 2px solid var(--border-color);
                border-radius: 10px;
                cursor: pointer;
            }

            /* File Input */
            .file-input-wrapper {
                position: relative;
            }

            .file-input-wrapper input[type="file"] {
                position: absolute;
                opacity: 0;
                width: 100%;
                height: 100%;
                cursor: pointer;
            }

            .file-input-label {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 14px;
                background: var(--bg-light);
                border: 2px dashed var(--border-color);
                border-radius: 10px;
                font-size: 13px;
                color: var(--text-muted);
                transition: all 0.2s ease;
                cursor: pointer;
            }

            .file-input-wrapper:hover .file-input-label {
                border-color: var(--primary-blue);
                background: rgba(1, 37, 150, 0.02);
            }

            /* Submit Button */
            .editor-footer {
                padding: 16px 20px;
                background: white;
                border-top: 1px solid var(--border-color);
            }

            .btn-save {
                width: 100%;
                padding: 16px;
                background: var(--primary-blue);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .btn-save:hover {
                background: var(--primary-blue-dark);
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(1, 37, 150, 0.3);
            }

            /* Preview Panel */
            .preview-panel {
                flex: 1;
                background: linear-gradient(135deg, #e8ecf4 0%, #f8faff 100%);
                display: flex;
                align-items: flex-start;
                justify-content: center;
                padding: 40px;
                overflow-y: auto;
            }

            /* Card Preview */
            .card-preview {
                width: 360px;
                background: white;
                border-radius: 24px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            .card-cover {
                width: 100%;
                height: 280px;
                background-color: #ddd;
                background-repeat: no-repeat;
                background-size: cover;
                background-position: center 50%;
                position: relative;
            }

            .card-cover::after {
                content: "";
                position: absolute;
                bottom: 0;
                width: 100%;
                height: 80px;
                background: linear-gradient(to top, white, transparent);
            }

            .card-info-box {
                background: var(--primary-blue);
                color: white;
                border-radius: 16px;
                padding: 20px;
                margin: -50px 20px 20px;
                position: relative;
                z-index: 2;
                box-shadow: 0 8px 24px rgba(1, 37, 150, 0.25);
            }

            .card-name {
                font-size: 20px;
                font-weight: 700;
                margin-bottom: 4px;
            }

            .card-role {
                font-size: 13px;
                opacity: 0.9;
                margin-bottom: 4px;
            }

            .card-company {
                font-size: 12px;
                opacity: 0.7;
            }

            .card-contacts {
                padding: 0 20px 20px;
            }

            .contact-item {
                display: flex;
                align-items: center;
                gap: 12px;
                background: var(--bg-light);
                padding: 12px 14px;
                border-radius: 10px;
                margin-bottom: 8px;
                font-size: 13px;
                color: var(--text-dark);
            }

            .contact-icon {
                width: 32px;
                height: 32px;
                border-radius: 8px;
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--primary-blue);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            .video-section {
                margin: 0 20px 20px;
                border-radius: 12px;
                overflow: hidden;
                background: #000;
                aspect-ratio: 16/9;
            }

            .video-placeholder {
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background: var(--bg-light);
                color: var(--text-muted);
                font-size: 12px;
            }

            .video-placeholder i {
                font-size: 32px;
                margin-bottom: 8px;
                color: #e53e3e;
            }

            /* Mobile Responsive */
            @media (max-width: 1200px) {
                .studio-container {
                    flex-direction: column;
                    height: auto;
                }

                .editor-panel {
                    width: 100%;
                    border-right: none;
                    border-bottom: 1px solid var(--border-color);
                }

                .preview-panel {
                    padding: 24px;
                    min-height: 60vh;
                }

                .card-preview {
                    width: 100%;
                    max-width: 360px;
                }
            }

            @media (max-width: 480px) {
                .editor-scroll {
                    padding: 16px;
                }

                .form-row {
                    grid-template-columns: 1fr;
                }
            }
        </style>
</head>

<body>
    <div class="main-wrapper">
        <!-- Header -->
        <%- include('../admin/header.ejs') %>

            <!-- Sidebar -->
            <%- include('../admin/sidebar.ejs') %>

                <!-- Page Wrapper -->
                <div class="page-wrapper">
                    <div class="studio-container">
                        <!-- Editor Panel -->
                        <div class="editor-panel">
                            <div class="editor-header">
                                <h2><i class="fas fa-paint-brush me-2"></i>Card Studio</h2>
                                <span class="template-badge">
                                    <%= template.name==='profsample-1' ? 'AT Energy Professional' : template.name %>
                                </span>
                            </div>

                            <form action="/businesscard/<%= user._id %>" method="POST" enctype="multipart/form-data"
                                class="d-flex flex-column" style="flex: 1; overflow: hidden;">
                                <input type="hidden" name="selectedItems" value='<%= JSON.stringify(selectedItem) %>'>
                                <input type="hidden" name="existingImage" value="<%= stImage %>">
                                <input type="hidden" name="existingBgImage"
                                    value="<%= (selectedItem && selectedItem.bgImg) ? selectedItem.bgImg : '' %>">

                                <div class="editor-scroll">
                                    <!-- Personal Info Section -->
                                    <div class="section-title">
                                        <i class="fas fa-user"></i>
                                        Thông tin cá nhân
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Họ và tên</label>
                                        <input type="text" name="Name" id="inputName" class="form-control"
                                            placeholder="Nguyễn Văn A" value="<%= stName %>">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Chức vụ</label>
                                        <input type="text" name="Role" id="inputRole" class="form-control"
                                            placeholder="Giám đốc kinh doanh" value="<%= stRole %>">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Email liên hệ</label>
                                        <input type="email" name="ContactEmail" id="inputEmail" class="form-control"
                                            placeholder="email@atenergy.vn" value="<%= stEmail %>">
                                    </div>

                                    <!-- Contact Section -->
                                    <div class="section-title">
                                        <i class="fas fa-phone"></i>
                                        Thông tin liên hệ
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Số di động</label>
                                            <input type="text" name="Phone1" id="inputPhone1" class="form-control"
                                                placeholder="0901 234 567" value="<%= stPhone1 %>">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Hotline / Văn phòng</label>
                                            <input type="text" name="Phone2" id="inputPhone2" class="form-control"
                                                placeholder="024 1234 5678" value="<%= stPhone2 %>">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Địa chỉ</label>
                                        <textarea name="Address" id="inputAddress" class="form-control" rows="2"
                                            placeholder="Số nhà, Đường, Quận, Thành phố"><%= stAddress %></textarea>
                                    </div>

                                    <!-- Company Section -->
                                    <div class="section-title">
                                        <i class="fas fa-building"></i>
                                        Công ty & Website
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Tên công ty</label>
                                        <input type="text" name="Company" id="inputCompany" class="form-control"
                                            placeholder="AT Energy JSC" value="<%= stCompany %>">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Website</label>
                                        <input type="text" name="URL" id="inputURL" class="form-control"
                                            placeholder="https://atenergy.vn" value="<%= stURL %>">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Link Video YouTube (Embed)</label>
                                        <input type="text" name="VideoURL" id="inputVideo" class="form-control"
                                            placeholder="https://www.youtube.com/embed/..." value="<%= stVideo %>">
                                    </div>

                                    <!-- Visual Section -->
                                    <div class="section-title">
                                        <i class="fas fa-image"></i>
                                        Hình ảnh & Màu sắc
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Ảnh đại diện / Ảnh bìa</label>
                                        <div class="file-input-wrapper">
                                            <input type="file" name="Image" id="inputImage" accept="image/*">
                                            <div class="file-input-label">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                                Chọn ảnh hoặc kéo thả vào đây
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Kiểu hiển thị ảnh</label>
                                            <select name="ImageFit" id="inputImageFit" class="form-control">
                                                <option value="cover" <%=getVal('ImageFit')==='cover' ? 'selected' : ''
                                                    %>>Phóng to</option>
                                                <option value="contain" <%=getVal('ImageFit')==='contain' ? 'selected'
                                                    : '' %>>Vừa khung</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Vị trí ảnh</label>
                                            <input type="range" name="ImagePos" id="inputImagePos" class="form-control"
                                                min="0" max="100" value="<%= getVal('ImagePos', '50') %>"
                                                style="padding: 8px;">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Màu chủ đạo</label>
                                        <div class="color-picker-wrapper">
                                            <input type="color" name="bgColor" id="inputBGColor" value="<%= stColor %>">
                                            <span style="font-size: 13px; color: var(--text-muted);">Chọn màu cho thẻ
                                                thông tin</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="editor-footer">
                                    <button type="submit" class="btn-save">
                                        <i class="fas fa-save"></i>
                                        Lưu Danh Thiếp
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Preview Panel -->
                        <div class="preview-panel">
                            <div class="card-preview" id="previewCanvas">
                                <div class="card-cover" id="previewCover"
                                    style="background-image: url('<%= stImage %>')"></div>

                                <div class="card-info-box" id="previewTheme" style="background-color: <%= stColor %>">
                                    <div class="card-name" id="previewName">
                                        <%= stName %>
                                    </div>
                                    <div class="card-role" id="previewRole">
                                        <%= stRole || 'Chức vụ' %>
                                    </div>
                                    <div class="card-company" id="previewCompany">
                                        <%= stCompany || 'Tên công ty' %>
                                    </div>
                                </div>

                                <div class="card-contacts">
                                    <div class="contact-item">
                                        <span class="contact-icon">
                                            <i class="fas fa-phone"></i>
                                        </span>
                                        <span id="previewPhone1">
                                            <%= stPhone1 %>
                                        </span>
                                    </div>
                                    <div class="contact-item">
                                        <span class="contact-icon">
                                            <i class="fas fa-envelope"></i>
                                        </span>
                                        <span id="previewEmail">
                                            <%= stEmail %>
                                        </span>
                                    </div>
                                    <div class="contact-item">
                                        <span class="contact-icon">
                                            <i class="fas fa-map-marker-alt"></i>
                                        </span>
                                        <span id="previewAddress">
                                            <%= stAddress || 'Địa chỉ' %>
                                        </span>
                                    </div>
                                </div>

                                <div class="video-section" id="videoContainer">
                                    <% if(stVideo) { %>
                                        <iframe src="<%= stVideo %>"
                                            style="width:100%; height:100%; border:none;"></iframe>
                                        <% } else { %>
                                            <div class="video-placeholder">
                                                <i class="fab fa-youtube"></i>
                                                <span>Video Preview</span>
                                            </div>
                                            <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
    </div>

    <!-- jQuery -->
    <script src="/public/assets/admin/js/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap Core JS -->
    <script src="/public/assets/admin/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Live Preview Script -->
    <script>
        const inputs = {
            Name: document.getElementById('inputName'),
            Role: document.getElementById('inputRole'),
            Company: document.getElementById('inputCompany'),
            Email: document.getElementById('inputEmail'),
            Phone1: document.getElementById('inputPhone1'),
            Address: document.getElementById('inputAddress'),
            VideoURL: document.getElementById('inputVideo'),
            BGColor: document.getElementById('inputBGColor'),
            Image: document.getElementById('inputImage'),
            ImageFit: document.getElementById('inputImageFit'),
            ImagePos: document.getElementById('inputImagePos')
        };

        const previews = {
            Name: document.getElementById('previewName'),
            Role: document.getElementById('previewRole'),
            Company: document.getElementById('previewCompany'),
            Email: document.getElementById('previewEmail'),
            Phone1: document.getElementById('previewPhone1'),
            Address: document.getElementById('previewAddress'),
            Theme: document.getElementById('previewTheme'),
            Cover: document.getElementById('previewCover'),
            Video: document.getElementById('videoContainer')
        };

        const updatePreview = () => {
            previews.Name.innerText = inputs.Name.value || 'Họ và tên';
            previews.Role.innerText = inputs.Role.value || 'Chức vụ';
            previews.Company.innerText = inputs.Company.value || 'Tên công ty';
            previews.Email.innerText = inputs.Email.value || 'email@example.com';
            previews.Phone1.innerText = inputs.Phone1.value || 'Số điện thoại';
            previews.Address.innerText = inputs.Address.value || 'Địa chỉ';
            previews.Theme.style.backgroundColor = inputs.BGColor.value;

            // Image preview styling
            previews.Cover.style.backgroundSize = inputs.ImageFit.value;
            previews.Cover.style.backgroundPosition = `center ${inputs.ImagePos.value}%`;

            // Video preview
            if (inputs.VideoURL.value) {
                previews.Video.innerHTML = `<iframe src="${inputs.VideoURL.value}" style="width:100%; height:100%; border:none;"></iframe>`;
            } else {
                previews.Video.innerHTML = `
                    <div class="video-placeholder">
                        <i class="fab fa-youtube"></i>
                        <span>Video Preview</span>
                    </div>
                `;
            }
        };

        // Attach event listeners
        Object.keys(inputs).forEach(key => {
            if (inputs[key]) inputs[key].addEventListener('input', updatePreview);
        });

        // Image file preview
        inputs.Image.addEventListener('change', function () {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => previews.Cover.style.backgroundImage = `url(${e.target.result})`;
                reader.readAsDataURL(this.files[0]);
            }
        });

        // Initialize on load
        window.addEventListener('load', updatePreview);
    </script>
</body>

</html>