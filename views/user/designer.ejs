<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <% const getVal=(name, fallback='' )=> {
        if (typeof selectedItem !== 'undefined' && selectedItem && selectedItem.templateFields) {
        const field = selectedItem.templateFields.find(f => f.fieldName === name);
        if (field && field.fieldValue) return field.fieldValue;
        }
        return fallback;
        };
        const stName = getVal('Name', user.username);
        const stRole = getVal('Role');
        const stEmail = getVal('ContactEmail', user.email);
        const stPhone1 = getVal('Phone1', user.number);
        const stPhone2 = getVal('Phone2');
        const stAddress = getVal('Address');
        const stCompany = getVal('Company');
        const stURL = getVal('URL');
        const stVideo = getVal('VideoURL');
        const stColor = (typeof selectedItem !== 'undefined' && selectedItem && selectedItem.bgColor) ?
        selectedItem.bgColor : '#012596';
        const stImage = (typeof selectedItem !== 'undefined' && selectedItem && selectedItem.Image) ? selectedItem.Image
        : '';
        %>
        <title>Designer Studio - AT Digital Card</title>
        <link rel="stylesheet" href="/public/assets/admin/plugins/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <style>
            :root {
                --primary: #012596;
                --bg: #f0f2f5;
            }

            body {
                background: #f4f6f9;
                height: 100vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .studio-navbar {
                background: white;
                border-bottom: 1px solid #ddd;
                padding: 10px 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .studio-container {
                flex: 1;
                display: flex;
                overflow: hidden;
            }

            .editor-panel {
                width: 400px;
                background: white;
                border-right: 1px solid #ddd;
                padding: 30px;
                overflow-y: auto;
            }

            .preview-panel {
                flex: 1;
                background: #f0f2f5;
                display: flex;
                align-items: flex-start;
                justify-content: center;
                padding: 40px;
                overflow-y: auto;
            }

            .card-canvas {
                width: 360px;
                min-height: 550px;
                background: white;
                border-radius: 30px;
                box-shadow: 0 30px 60px rgba(0, 0, 0, 0.12);
                position: relative;
                overflow: hidden;
                padding-bottom: 20px;
            }

            .preview-header-img {
                width: 100%;
                height: 350px;
                background-color: #ddd;
                background-repeat: no-repeat;
                background-size: cover;
                background-position: center 50%;
                position: relative;
            }

            .preview-header-img::after {
                content: "";
                position: absolute;
                bottom: 0;
                width: 100%;
                height: 60px;
                background: linear-gradient(to top, white, transparent);
            }

            .info-block {
                background: #00458b;
                color: white;
                border-radius: 20px;
                padding: 20px;
                margin: -40px 20px 20px;
                position: relative;
                z-index: 2;
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            }

            .contact-section {
                padding: 0 20px;
                margin-top: 10px;
            }

            .contact-item {
                display: flex;
                align-items: center;
                gap: 12px;
                background: #f8f9fa;
                padding: 12px 15px;
                border-radius: 12px;
                margin-bottom: 10px;
                font-size: 13px;
                color: #333;
                border: 1px solid #eee;
            }

            .contact-icon {
                width: 30px;
                height: 30px;
                border-radius: 50%;
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #00458b;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }

            .video-preview {
                margin: 20px;
                border-radius: 15px;
                overflow: hidden;
                background: #000;
                aspect-ratio: 16/9;
            }

            .video-placeholder {
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #444;
                font-size: 11px;
                background: #eee;
            }
        </style>
</head>

<body>
    <nav class="studio-navbar">
        <div class="d-flex align-items-center gap-3">
            <img src="/public/assets/AT-Energy-Logo-1024x200.png" height="35" class="me-3" alt="Logo">
            <h5 class="mb-0 fw-bold">Card Studio</h5>
        </div>
        <div>
            <span class="badge bg-light text-dark border p-2">Template: <%= template.name %></span>
        </div>
    </nav>

    <div class="studio-container">
        <!-- Sidebar Editor -->
        <div class="editor-panel">
            <form action="/businesscard/<%= user._id %>" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="selectedItems" value='<%= JSON.stringify(selectedItem) %>'>
                <input type="hidden" name="existingImage" value="<%= stImage %>">
                <input type="hidden" name="existingBgImage"
                    value="<%= (selectedItem && selectedItem.bgImg) ? selectedItem.bgImg : '' %>">

                <div class="control-group">
                    <h6 class="fw-bold mb-3"><i class="fa fa-user me-2"></i> Personal Info</h6>
                    <label class="form-label">Full Name</label>
                    <input type="text" name="Name" id="inputName" class="form-control" placeholder="John Doe"
                        value="<%= stName %>">

                    <label class="form-label">Professional Role</label>
                    <input type="text" name="Role" id="inputRole" class="form-control" placeholder="Senior Developer"
                        value="<%= stRole %>">

                    <label class="form-label">Contact Email</label>
                    <input type="email" name="ContactEmail" id="inputEmail" class="form-control"
                        placeholder="email@example.com" value="<%= stEmail %>">
                </div>

                <div class="control-group">
                    <h6 class="fw-bold mb-3"><i class="fa fa-phone me-2"></i> Contact Details</h6>
                    <label class="form-label">Phone Number 1</label>
                    <input type="text" name="Phone1" id="inputPhone1" class="form-control" value="<%= stPhone1 %>">

                    <label class="form-label">Phone Number 2</label>
                    <input type="text" name="Phone2" id="inputPhone2" class="form-control" placeholder="Secondary Phone"
                        value="<%= stPhone2 %>">

                    <label class="form-label">Detailed Address</label>
                    <textarea name="Address" id="inputAddress" class="form-control" rows="2"
                        placeholder="Street, City, Country"><%= stAddress %></textarea>
                </div>

                <div class="control-group">
                    <h6 class="fw-bold mb-3"><i class="fa fa-building me-2"></i> Company & Web</h6>
                    <label class="form-label">Company Name</label>
                    <input type="text" name="Company" id="inputCompany" class="form-control"
                        placeholder="Tech Solutions Inc." value="<%= stCompany %>">

                    <label class="form-label">Website URL</label>
                    <input type="text" name="URL" id="inputURL" class="form-control" placeholder="https://example.com"
                        value="<%= stURL %>">

                    <label class="form-label">YouTube Video Embed Link</label>
                    <input type="text" name="VideoURL" id="inputVideo" class="form-control"
                        placeholder="https://www.youtube.com/embed/..." value="<%= stVideo %>">
                </div>

                <div class="control-group">
                    <h6 class="fw-bold mb-3"><i class="fa fa-palette me-2"></i> Visuals</h6>
                    <label class="form-label">Profile/Cover Photo</label>
                    <input type="file" name="Image" id="inputImage" class="form-control" accept="image/*">

                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Image Fit</label>
                            <select name="ImageFit" id="inputImageFit" class="form-select">
                                <option value="cover" <%=getVal('ImageFit')==='cover' ? 'selected' : '' %>>Zoom to Fill
                                </option>
                                <option value="contain" <%=getVal('ImageFit')==='contain' ? 'selected' : '' %>>Fit
                                    Content</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Image Position</label>
                            <input type="range" name="ImagePos" id="inputImagePos" class="form-range" min="0" max="100"
                                value="<%= getVal('ImagePos', '50') %>">
                        </div>
                    </div>

                    <label class="form-label mt-3">Theme Color</label>
                    <input type="color" name="bgColor" id="inputBGColor" class="form-control p-1"
                        value="<%= stColor %>">
                </div>

                <button type="submit" class="btn btn-save mt-3">Finalize & Save Card</button>
            </form>
        </div>

        <!-- Live Preview -->
        <div class="preview-panel">
            <div id="captureArea">
                <div class="card-canvas" id="previewCanvas">
                    <div class="preview-header-img" id="previewCover" style="background-image: url('<%= stImage %>')">
                    </div>
                    <div class="card-content">
                        <div class="info-block" id="previewTheme" style="background-color: <%= stColor %>">
                            <h3 id="previewName" style="color:white; margin:0; font-size:20px; font-weight:700;">
                                <%= stName %>
                            </h3>
                            <p id="previewRole" style="font-size:13px; margin:5px 0; opacity:0.9;">
                                <%= stRole || 'Professional Role' %>
                            </p>
                            <p id="previewCompany" style="font-size:11px; margin:0; opacity:0.7;">
                                <%= stCompany || 'Company Name' %>
                            </p>
                        </div>

                        <div class="contact-section">
                            <div class="contact-item">
                                <span class="contact-icon"><i class="fa fa-phone"></i></span>
                                <span id="previewPhone1">
                                    <%= stPhone1 %>
                                </span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-icon"><i class="fa fa-envelope"></i></span>
                                <span id="previewEmail">
                                    <%= stEmail %>
                                </span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-icon"><i class="fa fa-map-marker-alt"></i></span>
                                <span id="previewAddress" style="line-height:1.4;">
                                    <%= stAddress || 'Address Line' %>
                                </span>
                            </div>
                        </div>

                        <div class="video-preview" id="videoContainer">
                            <% if(stVideo) { %>
                                <iframe src="<%= stVideo %>" style="width:100%; height:100%; border:none;"></iframe>
                                <% } else { %>
                                    <div class="video-placeholder">
                                        <div class="text-center">
                                            <i class="fab fa-youtube fa-2x mb-2" style="color:#ff0000;"></i>
                                            <p class="mb-0">Video Preview</p>
                                        </div>
                                    </div>
                                    <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <div class="position-absolute bottom-0 end-0 p-4">
                <p class="text-muted small mb-0"><i class="fa fa-info-circle me-1"></i> Hint: Your card is automatically
                    generated with a unique QR code.</p>
            </div>
        </div>
    </div>

    <!-- Scripts for Live Preview -->
    <script>
        // Live Update Logic
        const inputs = {
            Name: document.getElementById('inputName'),
            Role: document.getElementById('inputRole'),
            Company: document.getElementById('inputCompany'),
            Email: document.getElementById('inputEmail'),
            Phone1: document.getElementById('inputPhone1'),
            Address: document.getElementById('inputAddress'),
            VideoURL: document.getElementById('inputVideo'),
            BGColor: document.getElementById('inputBGColor'),
            Image: document.getElementById('inputImage'),
            ImageFit: document.getElementById('inputImageFit'),
            ImagePos: document.getElementById('inputImagePos')
        };

        const previews = {
            Name: document.getElementById('previewName'),
            Role: document.getElementById('previewRole'),
            Company: document.getElementById('previewCompany'),
            Email: document.getElementById('previewEmail'),
            Phone1: document.getElementById('previewPhone1'),
            Address: document.getElementById('previewAddress'),
            Theme: document.getElementById('previewTheme'),
            Cover: document.getElementById('previewCover'),
            Video: document.getElementById('videoContainer')
        };

        const updateAll = () => {
            previews.Name.innerText = inputs.Name.value || 'Full Name';
            previews.Role.innerText = inputs.Role.value || 'Professional Role';
            previews.Company.innerText = inputs.Company.value || 'Company Name';
            previews.Email.innerText = inputs.Email.value || 'email@example.com';
            previews.Phone1.innerText = inputs.Phone1.value || 'Phone Number';
            previews.Address.innerText = inputs.Address.value || 'Address Line';
            previews.Theme.style.backgroundColor = inputs.BGColor.value;

            // Image Preview Styling
            previews.Cover.style.backgroundSize = inputs.ImageFit.value;
            previews.Cover.style.backgroundPosition = `center ${inputs.ImagePos.value}%`;

            if (inputs.VideoURL.value) {
                previews.Video.innerHTML = `<iframe src="${inputs.VideoURL.value}" style="width:100%; height:100%; border:none;"></iframe>`;
            } else {
                previews.Video.innerHTML = `<div class="video-placeholder"><div class="text-center"><i class="fab fa-youtube fa-2x mb-2" style="color:#ff0000;"></i><p class="mb-0">Video Preview</p></div></div>`;
            }
        };

        Object.keys(inputs).forEach(key => {
            if (inputs[key]) inputs[key].addEventListener('input', updateAll);
        });

        inputs.Image.addEventListener('change', function () {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => previews.Cover.style.backgroundImage = `url(${e.target.result})`;
                reader.readAsDataURL(this.files[0]);
            }
        });

        // Initialize preview on load
        window.addEventListener('load', updateAll);
    </script>
</body>

</html>